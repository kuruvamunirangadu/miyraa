name: ONNX smoke test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  onnx-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install onnx onnxruntime

      - name: Create tiny ONNX model and run smoke inference
        run: |
          python - <<'PY'
          import onnx
          from onnx import helper, TensorProto
          import onnxruntime as ort

          # Build a tiny model: one input (batch, seq) int64, one attention mask
          input_ids = helper.make_tensor_value_info('input_ids', TensorProto.INT64, ['batch', 'seq'])
          attention_mask = helper.make_tensor_value_info('attention_mask', TensorProto.INT64, ['batch', 'seq'])
          logits = helper.make_tensor_value_info('logits', TensorProto.FLOAT, ['batch', 2])

          # A trivial identity node that forwards input_ids to logits via Cast and ReduceSum (toy)
          node_cast = helper.make_node('Cast', ['input_ids'], ['casted'], to=TensorProto.FLOAT)
          node_reducesum = helper.make_node('ReduceSum', ['casted'], ['pooled'], axes=[1], keepdims=1)
          node_flat = helper.make_node('Flatten', ['pooled'], ['flat'])
          node_fc = helper.make_node('Gemm', ['flat', 'W', 'B'], ['logits'])

          # small initializer for W and B
          import numpy as np
          W = np.random.randn(1, 2).astype(np.float32)
          B = np.random.randn(2).astype(np.float32)

          init_W = helper.make_tensor('W', TensorProto.FLOAT, [1, 2], W.flatten().tolist())
          init_B = helper.make_tensor('B', TensorProto.FLOAT, [2], B.flatten().tolist())

          graph = helper.make_graph(
              nodes=[node_cast, node_reducesum, node_flat, node_fc],
              name='tiny',
              inputs=[input_ids, attention_mask],
              outputs=[logits],
              initializer=[init_W, init_B],
          )

          model = helper.make_model(graph)
          onnx.save(model, 'outputs/tiny_test.onnx')

          sess = ort.InferenceSession('outputs/tiny_test.onnx')
          import numpy as np
          ids = np.zeros((1, 8), dtype=np.int64)
          mask = np.ones((1, 8), dtype=np.int64)
          out = sess.run(None, {sess.get_inputs()[0].name: ids, sess.get_inputs()[1].name: mask})
          print('ONNX smoke output shape:', [o.shape for o in out])
          PY
